 <!-- TODO: Jade -->
 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenSpaceUrban - My Items</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2E8B57;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 20px;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(11, 44, 12, 0.13);
            padding: 15px 20px;
            color: white;
        }

        .navbar-brand {
            font-size: 1.5em;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background-color: #45a049;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }

        .filter-section {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }

        .filter-section h1 {
            color: white;
            margin: 0 0 20px 0;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: white;
            margin-bottom: 5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: white;
        }

        .stats-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .upload-button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .save-btn,
        .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .save-btn {
            background: #4CAF50;
            color: white;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .item-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
        }
        .swap-requests-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .swap-requests-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .swap-request-card {
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .request-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .accept-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .reject-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">GreenSpaceUrban</div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="my-profile.html">My Profile</a>
            <a href="#" id="logout-btn">Logout</a>
        </div>
    </nav>

    <div class="container">
        <button class="upload-button" onclick="openUploadModal()">Upload New Item</button>

        <div class="filter-section">
            <h1>My Items</h1>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="category-filter">Category</label>
                    <select id="category-filter">
                        <option value="all">All Categories</option>
                        <option value="tops">Tops</option>
                        <option value="bottoms">Bottoms</option>
                        <option value="shoes">Shoes</option>
                        <option value="accessories">Accessories</option>
                        <option value="dresses">Dresses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="status-filter">Status</label>
                    <select id="status-filter">
                        <option value="all">All Statuses</option>
                        <option value="available">Available</option>
                        <option value="pending">Pending</option>
                        <option value="swapped">Swapped</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sort-by">Sort By</label>
                    <select id="sort-by">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" placeholder="Search items...">
                </div>
            </div>
        </div>

        <div class="items-grid"></div>
           <!-- Swap Requests Modal -->
    <div id="swap-requests-modal" class="swap-requests-modal">
        <div class="swap-requests-content">
            <h2>Swap Requests</h2>
            <div id="swap-requests-container"></div>
            <button class="btn" onclick="closeSwapRequestsModal()">Close</button>
        </div>
    </div>

        <div class="stats-section">
            <h2>Item Statistics</h2>
            <div class="stat-grid">
                <div class="stat-item">
                    <strong>Total Items</strong>
                    <div id="total-items-count">0</div>
                </div>
                <div class="stat-item">
                    <strong>Available</strong>
                    <div id="available-items-count">0</div>
                </div>
                <div class="stat-item">
                    <strong>Pending</strong>
                    <div id="pending-items-count">0</div>
                </div>
                <div class="stat-item">
                    <strong>Swapped</strong>
                    <div id="swapped-items-count">0</div>
                </div>
            </div>
        </div>

        <div id="upload-modal" class="modal">
            <div class="modal-content">
                <h2>Upload New Item</h2>
                <form id="upload-form">
                    <div class="form-group">
                        <label for="item-name">Item Name</label>
                        <input type="text" id="item-name" required>
                    </div>
                    <div class="form-group">
                        <label for="item-description">Description</label>
                        <textarea id="item-description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="item-category">Category</label>
                        <select id="item-category" required>
                            <option value="tops">Tops</option>
                            <option value="bottoms">Bottoms</option>
                            <option value="shoes">Shoes</option>
                            <option value="accessories">Accessories</option>
                            <option value="dresses">Dresses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-size">Size</label>
                        <select id="item-size" required>
                            <option value="s">Small</option>
                            <option value="m">Medium</option>
                            <option value="l">Large</option>
                            <option value="xl">XL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-image">Image</label>
                        <input type="file" id="item-image" accept="image/*" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeUploadModal()">Cancel</button>
                        <button type="submit" class="save-btn">Upload</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="edit-modal" class="modal">
            <div class="modal-content">
                <h2>Edit Item</h2>
                <form id="edit-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="form-group">
                        <label for="edit-item-name">Item Name</label>
                        <input type="text" id="edit-item-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-description">Description</label>
                        <textarea id="edit-description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-category">Category</label>
                        <select id="edit-category" required>
                            <option value="tops">Tops</option>
                            <option value="bottoms">Bottoms</option>
                            <option value="shoes">Shoes</option>
                            <option value="accessories">Accessories</option>
                            <option value="dresses">Dresses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-size">Size</label>
                        <select id="edit-size" required>
                            <option value="s">Small</option>
                            <option value="m">Medium</option>
                            <option value="l">Large</option>
                            <option value="xl">XL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-status">Status</label>
                        <select id="edit-status" required>
                            <option value="available">Available</option>
                            <option value="pending">Pending</option>
                            <option value="swapped">Swapped</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="save-btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            deleteDoc, 
            doc, 
            updateDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-firestore.js";

// Delete previous script content and replace with this:
const firebaseConfig = {
    apiKey: "AIzaSyDt9N3uuNjh5UkmHgAYjgSajBLYVmw35Rk",
    authDomain: "greenspaceweb-739cb.firebaseapp.com", 
    projectId: "greenspaceweb-739cb",
    storageBucket: "greenspaceweb-739cb.firebasestorage.app",
    messagingSenderId: "7717633332",
    appId: "1:7717633332:web:a82a062bf6c848d0ef3961"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// Add these functions in your script section before the initialization code

// Modal functions
window.openUploadModal = () => {
    document.getElementById('upload-modal').style.display = 'flex';
};

window.closeUploadModal = () => {
    document.getElementById('upload-modal').style.display = 'none';
    document.getElementById('upload-form').reset();
};

window.openEditModal = () => document.getElementById('edit-modal').style.display = 'flex';
window.closeEditModal = () => document.getElementById('edit-modal').style.display = 'none';

// Stats update function
function updateStats(items) {
    const stats = {
        total: items.length,
        available: items.filter(item => item.status === 'available').length,
        pending: items.filter(item => item.status === 'pending').length,
        swapped: items.filter(item => item.status === 'swapped').length
    };

    document.getElementById('total-items-count').textContent = stats.total;
    document.getElementById('available-items-count').textContent = stats.available;
    document.getElementById('pending-items-count').textContent = stats.pending;
    document.getElementById('swapped-items-count').textContent = stats.swapped;
}

// Upload form handler
document.getElementById('upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) {
        alert('Please log in to upload items');
        return;
    }

    try {
        const file = document.getElementById('item-image').files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const imageData = e.target.result;
                
                await addDoc(collection(db, 'items'), {
                    name: document.getElementById('item-name').value,
                    description: document.getElementById('item-description').value,
                    category: document.getElementById('item-category').value,
                    size: document.getElementById('item-size').value,
                    imageData: imageData,
                    userId: user.uid,
                    status: 'available',
                    dateAdded: new Date()
                });

                closeUploadModal();
                loadUserItems();
            } catch (error) {
                console.error('Error saving item:', error);
                alert('Failed to save item. Please try again.');
            }
        };

        reader.readAsDataURL(file);
    } catch (error) {
        console.error('Error uploading item:', error);
        alert('Failed to upload item. Please try again.');
    }
});

// Edit form handler
document.getElementById('edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const itemId = document.getElementById('edit-item-id').value;
    if (!itemId) return;

    try {
        await updateDoc(doc(db, 'items', itemId), {
            name: document.getElementById('edit-item-name').value,
            description: document.getElementById('edit-description').value,
            category: document.getElementById('edit-category').value,
            size: document.getElementById('edit-size').value,
            status: document.getElementById('edit-status').value
        });

        closeEditModal();
        loadUserItems();
    } catch (error) {
        console.error('Error updating item:', error);
        alert('Failed to update item. Please try again.');
    }
});

// Delete item handler
window.deleteItem = async (itemId) => {
    if (confirm('Are you sure you want to delete this item?')) {
        try {
            await deleteDoc(doc(db, 'items', itemId));
            loadUserItems();
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('Failed to delete item');
        }
    }
};

// Edit item handler
window.editItem = async (itemId) => {
    const docRef = doc(db, 'items', itemId);
    try {
        const itemDoc = await getDoc(docRef);
        const item = itemDoc.data();

        // Populate edit form
        document.getElementById('edit-item-id').value = itemId;
        document.getElementById('edit-item-name').value = item.name;
        document.getElementById('edit-description').value = item.description;
        document.getElementById('edit-category').value = item.category;
        document.getElementById('edit-size').value = item.size;
        document.getElementById('edit-status').value = item.status;
        
        openEditModal();
    } catch (error) {
        console.error('Error loading item for edit:', error);
        alert('Failed to load item details');
    }
};

window.viewSwapRequests = async (itemId) => {
            const modal = document.getElementById('swap-requests-modal');
            const container = document.getElementById('swap-requests-container');
            container.innerHTML = '';
            modal.style.display = 'flex';

            try {
                const q = query(
                    collection(db, 'swapRequests'),
                    where('requestedItemId', '==', itemId),
                    where('status', '==', 'pending'),
                    orderBy('timestamp', 'desc')
                );

                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    container.innerHTML = '<p>No pending swap requests for this item.</p>';
                    return;
                }

                for (const doc of querySnapshot.docs) {
                    const request = doc.data();
                    const offeredItem = await getDoc(doc.ref.collection('items').doc(request.offeredItemId));
                    const offeredItemData = offeredItem.data();

                    const requestCard = document.createElement('div');
                    requestCard.className = 'swap-request-card';
                    requestCard.innerHTML = `
                        <p><strong>From:</strong> ${request.requesterEmail}</p>
                        <p><strong>Offered Item:</strong> ${offeredItemData.name}</p>
                        <p><strong>Message:</strong> ${request.message || 'No message'}</p>
                        <div class="request-actions">
                            <button class="accept-btn" onclick="handleSwapRequest('${doc.id}', 'accept')">Accept</button>
                            <button class="reject-btn" onclick="handleSwapRequest('${doc.id}', 'reject')">Reject</button>
                        </div>
                    `;
                    container.appendChild(requestCard);
                }
            } catch (error) {
                console.error('Error loading swap requests:', error);
                container.innerHTML = '<p>Error loading swap requests. Please try again.</p>';
            }
        };

        window.closeSwapRequestsModal = () => {
            document.getElementById('swap-requests-modal').style.display = 'none';
        };

        window.handleSwapRequest = async (requestId, action) => {
            try {
                const requestRef = doc(db, 'swapRequests', requestId);
                const request = await getDoc(requestRef);
                const requestData = request.data();

                if (action === 'accept') {
                    // Update both items' status
                    await updateDoc(doc(db, 'items', requestData.requestedItemId), {
                        status: 'swapped'
                    });
                    await updateDoc(doc(db, 'items', requestData.offeredItemId), {
                        status: 'swapped'
                    });

                    // Update request status
                    await updateDoc(requestRef, {
                        status: 'accepted'
                    });

                    // Reject all other pending requests for both items
                    const otherRequests = query(
                        collection(db, 'swapRequests'),
                        where('status', '==', 'pending'),
                        where('requestedItemId', 'in', [requestData.requestedItemId, requestData.offeredItemId])
                    );
                    const snapshot = await getDocs(otherRequests);
                    snapshot.forEach(async (doc) => {
                        if (doc.id !== requestId) {
                            await updateDoc(doc.ref, {
                                status: 'rejected',
                                rejectionReason: 'Item was swapped with another user'
                            });
                        }
                    });

                    alert('Swap accepted successfully!');
                } else if (action === 'reject') {
                    await updateDoc(requestRef, {
                        status: 'rejected',
                        rejectionReason: 'Request rejected by item owner'
                    });
                    alert('Swap request rejected');
                }

                closeSwapRequestsModal();
                loadUserItems(); // Refresh the items list
            } catch (error) {
                console.error('Error handling swap request:', error);
                alert('Error processing swap request. Please try again.');
            }
        };

        // Modify createItemCard to include swap status
        function createItemCard(item, itemId) {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            let statusBadge = '';
            if (item.status === 'swapped') {
                statusBadge = '<span class="status-badge swapped">Swapped</span>';
            } else if (item.status === 'pending') {
                statusBadge = '<span class="status-badge pending">Pending Swap</span>';
            }

            card.innerHTML = `
                <img src="${item.imageData}" alt="${item.name}" class="item-image">
                <h3 class="item-name">${item.name}</h3>
                <p class="item-category"><strong>Category:</strong> ${item.category}</p>
                <p class="item-size"><strong>Size:</strong> ${item.size}</p>
                <p class="item-status">
                    <strong>Status:</strong> ${item.status} ${statusBadge}
                </p>
                <p class="item-date-added">
                    <strong>Date Added:</strong> ${item.dateAdded.toDate().toLocaleDateString()}
                </p>
                <div class="item-actions">
                    ${item.status === 'available' ? `
                        <button onclick="editItem('${itemId}')" class="edit-button">Edit</button>
                        <button onclick="viewSwapRequests('${itemId}')" class="view-swap-requests-button">
                            View Swap Requests
                        </button>
                    ` : ''}
                    <button onclick="deleteItem('${itemId}')" class="delete-button">Delete</button>
                </div>
            `;
            return card;
        }

        // Modify loadUserItems to include swap requests count
        async function loadUserItems() {
            const user = auth.currentUser;
            if (!user) return;

            const itemsGrid = document.querySelector('.items-grid');
            itemsGrid.innerHTML = '';

            try {
                // Get user's items
                const q = query(
                    collection(db, 'items'),
                    where('userId', '==', user.uid),
                    orderBy('dateAdded', 'desc')
                );

                const querySnapshot = await getDocs(q);
                const items = [];
                
                // Get pending swap requests for each item
                for (const doc of querySnapshot.docs) {
                    const item = { id: doc.id, ...doc.data() };
                    
                    // Count pending swap requests
                    const swapRequestsQuery = query(
                        collection(db, 'swapRequests'),
                        where('requestedItemId', '==', doc.id),
                        where('status', '==', 'pending')
                    );
                    const swapRequestsSnapshot = await getDocs(swapRequestsQuery);
                    item.pendingSwapRequests = swapRequestsSnapshot.size;
                    
                    items.push(item);
                }

                // Apply filters
                const categoryFilter = document.getElementById('category-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                const searchTerm = document.getElementById('search').value.toLowerCase();
                const sortBy = document.getElementById('sort-by').value;

                let filteredItems = items;

                if (categoryFilter !== 'all') {
                    filteredItems = filteredItems.filter(item => item.category === categoryFilter);
                }
                if (statusFilter !== 'all') {
                    filteredItems = filteredItems.filter(item => item.status === statusFilter);
                }
                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.category.toLowerCase().includes(searchTerm)
                    );
                }

                // Sort items
                filteredItems.sort((a, b) => {
                    if (sortBy === 'newest') {
                        return b.dateAdded.toDate() - a.dateAdded.toDate();
                    } else {
                        return a.dateAdded.toDate() - b.dateAdded.toDate();
                    }
                });

                filteredItems.forEach(item => {
                    const itemCard = createItemCard(item, item.id);
                    itemsGrid.appendChild(itemCard);
                });

                updateStats(items);
            } catch (error) {
                console.error('Error loading items:', error);
                alert('Error loading items. Please refresh the page.');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    loadUserItems();
                } else {
                    window.location.href = 'index.html';
                }
            });
        });

        // Event listeners for filters
        document.getElementById('category-filter').addEventListener('change', loadUserItems);
        document.getElementById('status-filter').addEventListener('change', loadUserItems);
        document.getElementById('sort-by').addEventListener('change', loadUserItems);
        document.getElementById('search').addEventListener('input', loadUserItems);
    </script>
 </body>
 </body>
 </html>